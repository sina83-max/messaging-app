<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WebSocket Chat Tester</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    .panel { border: 1px solid #ddd; padding: 12px; margin-bottom: 12px; }
    #log { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 8px; background:#fafafa; }
    .msg { margin: 6px 0; }
    .sent { color: #0b6623; }
    .recv { color: #1a73e8; }
    label { display:block; margin-top:8px; }
    input, button, textarea { font-size: 14px; }
  </style>
</head>
<body>
  <h2>WebSocket Chat Tester</h2>

  <div class="panel">
    <label>WebSocket URL (no token):</label>
    <input id="wsUrl" type="text" value="ws://localhost:8000/chat/" style="width:100%"/>
    <label>JWT Token:</label>
    <input id="token" type="text" placeholder="Paste JWT here" style="width:100%"/>
    <label>Your user id (used in messages only, show what server expects):</label>
    <input id="myId" type="number" placeholder="e.g. 12" style="width:200px"/>
    <div style="margin-top:8px">
      <button id="connectBtn">Connect</button>
      <button id="disconnectBtn" disabled>Disconnect</button>
    </div>
  </div>

  <div class="panel">
    <strong>Send a message</strong>
    <label>Recipient ID:</label>
    <input id="recipientId" type="number" placeholder="recipient user id" style="width:200px"/>
    <label>Message content:</label>
    <textarea id="msgContent" rows="3" style="width:100%"></textarea>
    <div style="margin-top:8px">
      <button id="sendBtn" disabled>Send</button>
    </div>
  </div>

  <div class="panel">
    <strong>Messages</strong>
    <div id="log"></div>
  </div>

<script>
(function () {
  const wsUrlInput = document.getElementById('wsUrl');
  const tokenInput = document.getElementById('token');
  const myIdInput = document.getElementById('myId');
  const connectBtn = document.getElementById('connectBtn');
  const disconnectBtn = document.getElementById('disconnectBtn');
  const sendBtn = document.getElementById('sendBtn');
  const recipientInput = document.getElementById('recipientId');
  const msgContent = document.getElementById('msgContent');
  const log = document.getElementById('log');

  let ws = null;

  function appendLog(text, cls) {
    const d = document.createElement('div');
    d.className = 'msg ' + (cls||'');
    d.textContent = text;
    log.appendChild(d);
    log.scrollTop = log.scrollHeight;
  }

  connectBtn.onclick = function () {
    const base = wsUrlInput.value.trim();
    const token = tokenInput.value.trim();
    if (!base) { alert('Enter ws url'); return; }
    if (!token) { alert('Enter JWT token'); return; }

    // Build URL with token query param
    const sep = base.includes('?') ? '&' : '?';
    const fullUrl = base + sep + 'token=' + encodeURIComponent(token);

    appendLog('[system] connecting to ' + fullUrl);
    try {
      ws = new WebSocket(fullUrl);

      ws.onopen = function () {
        appendLog('[system] connected', 'sent');
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
        sendBtn.disabled = false;
      };

      ws.onmessage = function (evt) {
        // server should send JSON messages
        let txt = evt.data;
        try {
          const obj = JSON.parse(txt);
          // Pretty print message (either as received payload or server wrapper)
          if (obj.sender_id || obj.sender || obj.content) {
            appendLog('[recv] ' + JSON.stringify(obj), 'recv');
          } else {
            appendLog('[recv raw] ' + txt, 'recv');
          }
        } catch (e) {
          appendLog('[recv raw] ' + txt, 'recv');
        }
      };

      ws.onclose = function () {
        appendLog('[system] disconnected', 'sent');
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
        sendBtn.disabled = true;
      };

      ws.onerror = function (err) {
        appendLog('[error] ' + JSON.stringify(err));
      };

    } catch (err) {
      appendLog('[error] ' + err.toString());
    }
  };

  disconnectBtn.onclick = function () {
    if (ws) {
      ws.close();
      ws = null;
    }
  };

  sendBtn.onclick = function () {
    if (!ws || ws.readyState !== WebSocket.OPEN) {
      alert('WebSocket is not open');
      return;
    }
    const recipient = recipientInput.value.trim();
    const content = msgContent.value.trim();
    const myId = myIdInput.value.trim() || null;

    if (!recipient || !content) {
      alert('recipient and content required');
      return;
    }

    // Build message payload expected by server
    const payload = {
      recipient_id: Number(recipient),
      content: content
    };
    // Optionally include sender id if server expects it
    if (myId) payload.sender_id = Number(myId);

    ws.send(JSON.stringify(payload));
    appendLog('[sent] ' + JSON.stringify(payload), 'sent');
    msgContent.value = '';
  };

})();
</script>
</body>
</html>
